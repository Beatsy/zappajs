<!DOCTYPE html>  <html> <head>   <title>zappa.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               zappa.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>Zappa</strong> is a <a href="http://coffeescript.org">CoffeeScript</a> DSL-ish interface for building web apps on the
<a href="http://nodejs.org">node.js</a> runtime, integrating <a href="http://expressjs.com">express</a>, <a href="http://socket.io">socket.io</a>
and other best-of-breed libraries.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">log = </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
<span class="nv">fs = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="nv">path = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>

<span class="vi">@version = </span><span class="s1">&#39;0.2.0beta&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>CoffeeScript-generated JavaScript may contain anyone of these; when we "rewrite"
a function (see below) though, it loses access to its parent scope, and consequently to
any helpers it might need. So we need to reintroduce these helpers manually inside any
"rewritten" function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">coffeescript_helpers = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  var __slice = Array.prototype.slice;</span>
<span class="s2">  var __hasProp = Object.prototype.hasOwnProperty;</span>
<span class="s2">  var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };</span>
<span class="s2">  var __extends = function(child, parent) {</span>
<span class="s2">    for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; }</span>
<span class="s2">    function ctor() { this.constructor = child; }</span>
<span class="s2">    ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype;</span>
<span class="s2">    return child; };</span>
<span class="s2">  var __indexOf = Array.prototype.indexOf || function(item) {</span>
<span class="s2">    for (var i = 0, l = this.length; i &lt; l; i++) {</span>
<span class="s2">      if (this[i] === item) return i;</span>
<span class="s2">    } return -1; };</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>"Rewrites" a function so that it accepts the value of @/this ("context")
and local variables as parameters.
The names of local variables to be "extracted" have to be provided beforehand.
The function will lose access to its parent scope in the process.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rewrite_function = </span><span class="nf">(func, locals_names) -&gt;</span>
  <span class="nv">code = </span><span class="nb">String</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span>
  <span class="nv">code = </span><span class="s2">&quot;function () {#{code}}&quot;</span> <span class="nx">unless</span> <span class="nx">code</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;function&#39;</span> <span class="o">is</span> <span class="mi">0</span>
  <span class="nv">code = </span><span class="s2">&quot;#{coffeescript_helpers}return (#{code}).apply(context, args);&quot;</span>
  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">locals_names</span>
    <span class="nv">code = </span><span class="s2">&quot;var #{name} = locals.#{name};&quot;</span> <span class="o">+</span> <span class="nx">code</span>
  <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="s1">&#39;locals&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The stringified zappa client.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">client = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./client&#39;</span><span class="p">).</span><span class="nx">build</span><span class="p">(</span><span class="nx">@version</span><span class="p">,</span> <span class="nx">coffeescript_helpers</span><span class="p">,</span> <span class="nx">rewrite_function</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Takes in a function and builds express/socket.io apps based on the rules contained in it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@app = </span><span class="nf">(root_function) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Names of local variables that we have to know beforehand, to use with <code>rewrite_function</code>.
Helpers and defs will be known after we execute the user-provided <code>root_function</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The last four (<code>require</code>, <code>module</code>, <code>__filename</code> and <code>__dirname</code>) are not actually real globals,
but locals to each module.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">globals = </span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="s1">&#39;process&#39;</span><span class="p">,</span> <span class="s1">&#39;console&#39;</span><span class="p">,</span> <span class="s1">&#39;setTimeout&#39;</span><span class="p">,</span> <span class="s1">&#39;clearTimeout&#39;</span><span class="p">,</span> <span class="s1">&#39;setInterval&#39;</span><span class="p">,</span> <span class="s1">&#39;clearInterval&#39;</span><span class="p">,</span>
    <span class="s1">&#39;require&#39;</span><span class="p">,</span> <span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;__filename&#39;</span><span class="p">,</span> <span class="s1">&#39;__dirname&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>TODO: using?, route?, postrender?, settings, error</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">root_locals_names = </span><span class="p">[</span><span class="s1">&#39;express&#39;</span><span class="p">,</span> <span class="s1">&#39;io&#39;</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">,</span>
    <span class="s1">&#39;helper&#39;</span><span class="p">,</span> <span class="s1">&#39;def&#39;</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;configure&#39;</span><span class="p">,</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">,</span> <span class="s1">&#39;coffee&#39;</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">,</span>
    <span class="s1">&#39;enable&#39;</span><span class="p">,</span> <span class="s1">&#39;disable&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>TODO: app? (something shared with ws_handlers), app.clients?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">http_locals_names = </span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>TODO: emit?, broadcast, render?, app? (shared between http-ws, persistent)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ws_locals_names = </span><span class="p">[</span><span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;client&#39;</span><span class="p">]</span>
  <span class="nv">helpers_names = </span><span class="p">[]</span>
  <span class="nv">defs_names = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Storage for the functions provided by the user.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">routes = </span><span class="p">[]</span>
  <span class="nv">ws_handlers = </span><span class="p">{}</span>
  <span class="nv">helpers = </span><span class="p">{}</span>
  <span class="nv">defs = </span><span class="p">{}</span>
  <span class="nv">views = </span><span class="p">{}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Builds the applications's root scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">express = </span><span class="nx">require</span> <span class="s1">&#39;express&#39;</span>
  <span class="nv">socketio = </span><span class="nx">require</span> <span class="s1">&#39;socket.io&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Monkeypatch express to support inline templates. Such is life.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">express</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__defineGetter__</span> <span class="s1">&#39;exists&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">views</span><span class="p">[</span><span class="nx">@view</span><span class="p">]</span><span class="o">?</span>
    <span class="k">try</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">@path</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="k">return</span> <span class="kc">false</span>
  <span class="nx">express</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__defineGetter__</span> <span class="s1">&#39;contents&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">views</span><span class="p">[</span><span class="nx">@view</span><span class="p">]</span> <span class="k">if</span> <span class="nx">views</span><span class="p">[</span><span class="nx">@view</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">@path</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span>

  <span class="nv">app = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span>
  <span class="nv">io = </span><span class="nx">socketio</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
  <span class="nx">io</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;log level&#39;</span><span class="p">,</span> <span class="mi">1</span>

  <span class="nv">root_context = </span><span class="p">{}</span>
  <span class="nv">root_locals = </span><span class="p">{</span><span class="nx">express</span><span class="p">,</span> <span class="nx">io</span><span class="p">,</span> <span class="nx">app</span><span class="p">}</span>
  <span class="nx">root_locals</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="k">for</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">globals</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>These "globals" are actually local to each module, so we get our values
from our parent module.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">root_locals.module = </span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span>
  <span class="nv">root_locals.__filename = </span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">filename</span>
  <span class="nv">root_locals.__dirname = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>TODO: Find out how to pass the correct <code>require</code> (the module's, not zappa's) to the app.
root_locals.require = ???
Meanwhile, adding the app's root dir to the front of the lookup stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">require</span><span class="p">.</span><span class="nx">paths</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">root_locals</span><span class="p">.</span><span class="nx">__dirname</span>
  
  <span class="k">for</span> <span class="nx">verb</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span> <span class="s1">&#39;del&#39;</span><span class="p">]</span>
    <span class="nx">do</span> <span class="nf">(verb) -&gt;</span>
      <span class="nx">root_locals</span><span class="p">[</span><span class="nx">verb</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="s1">&#39;object&#39;</span>
          <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="nx">verb</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">handler: </span><span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="nx">verb</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">handler: </span><span class="nx">v</span>

  <span class="nv">root_locals.client = </span><span class="nf">(obj) -&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">enable</span> <span class="s1">&#39;zappa client&#39;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nv">js = </span><span class="s2">&quot;;zappa.run(#{v});&quot;</span>
      <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">handler: </span><span class="nx">js</span><span class="p">,</span> <span class="nv">contentType: </span><span class="s1">&#39;js&#39;</span>

  <span class="nv">root_locals.coffee = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nv">js = </span><span class="s2">&quot;;#{coffeescript_helpers}(#{v})();&quot;</span>
      <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">handler: </span><span class="nx">js</span><span class="p">,</span> <span class="nv">contentType: </span><span class="s1">&#39;js&#39;</span>

  <span class="nv">root_locals.js = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nv">js = </span><span class="nb">String</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">handler: </span><span class="nx">js</span><span class="p">,</span> <span class="nv">contentType: </span><span class="s1">&#39;js&#39;</span>

  <span class="nv">root_locals.css = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nv">css = </span><span class="nb">String</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="nx">routes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">verb: </span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="nv">path: </span><span class="nx">k</span><span class="p">,</span> <span class="nv">handler: </span><span class="nx">css</span><span class="p">,</span> <span class="nv">contentType: </span><span class="s1">&#39;css&#39;</span>

  <span class="nv">root_locals.helper = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">helpers_names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">k</span>
      <span class="nx">helpers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

  <span class="nv">root_locals.def = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">defs_names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">k</span>
      <span class="nx">defs</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

  <span class="nv">root_locals.at = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">ws_handlers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

  <span class="nv">root_locals.view = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">views</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>

  <span class="nv">root_locals.set = </span><span class="nf">(obj) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span>
      
  <span class="nv">root_locals.enable = </span><span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">enable</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">arguments</span>

  <span class="nv">root_locals.disable = </span><span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">disable</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">arguments</span>

  <span class="nv">root_locals.use = </span><span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">arguments</span>

  <span class="nv">root_locals.configure = </span><span class="o">-&gt;</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">arguments</span>

  <span class="nv">root_locals.include = </span><span class="nf">(name) -&gt;</span>
    <span class="nv">sub = </span><span class="nx">root_locals</span><span class="p">.</span><span class="nx">require</span> <span class="nx">name</span>
    <span class="nv">rewritten_sub = </span><span class="nx">rewrite_function</span><span class="p">(</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">root_locals_names</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globals</span><span class="p">))</span>

    <span class="nv">include_locals = </span><span class="p">{}</span>
    <span class="nx">include_locals</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">root_locals</span>

    <span class="nv">include_module = </span><span class="nx">require</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">name</span><span class="p">)]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>These "globals" are actually local to each module, so we get our values
from the required module.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">include_locals.module = </span><span class="nx">include_module</span>
    <span class="nv">include_locals.__filename = </span><span class="nx">include_module</span><span class="p">.</span><span class="nx">filename</span>
    <span class="nv">include_locals.__dirname = </span><span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">include_module</span><span class="p">.</span><span class="nx">filename</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>TODO: Find out how to pass the correct <code>require</code> (the module's, not zappa's) to the include.
include_locals.require = ???</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">rewritten_sub</span><span class="p">(</span><span class="nx">root_context</span><span class="p">,</span> <span class="nx">include_locals</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Executes the (rewriten) end-user function and learns how the app should be structured.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">rewritten_root = </span><span class="nx">rewrite_function</span><span class="p">(</span><span class="nx">root_function</span><span class="p">,</span> <span class="nx">root_locals_names</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globals</span><span class="p">))</span>
  <span class="nx">rewritten_root</span><span class="p">(</span><span class="nx">root_context</span><span class="p">,</span> <span class="nx">root_locals</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Implements the application according to the specification.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">helpers</span>
    <span class="nx">helpers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rewrite_function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">http_locals_names</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">helpers_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">defs_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globals</span><span class="p">))</span>

  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">ws_handlers</span>
    <span class="nx">ws_handlers</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rewrite_function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">ws_locals_names</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">helpers_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">defs_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globals</span><span class="p">))</span>

  <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="s1">&#39;zappa client&#39;</span><span class="p">]</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/zappa/zappa.js&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s1">&#39;js&#39;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="s2">&quot;;#{coffeescript_helpers}(#{client})();&quot;</span>

  <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="s1">&#39;jquery&#39;</span><span class="p">]</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/zappa/jquery.js&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s1">&#39;js&#39;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s1">&#39;../vendor/jquery-1.6.2.min.js&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>

  <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="s1">&#39;sammy&#39;</span><span class="p">]</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/zappa/sammy.js&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="s1">&#39;js&#39;</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="s1">&#39;../vendor/sammy-latest.min.js&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Implements the http server with express.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">routes</span>
    <span class="nx">do</span> <span class="nf">(r) -&gt;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">r</span><span class="p">.</span><span class="nx">handler</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
        <span class="nx">app</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span><span class="p">]</span> <span class="nx">r</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span> <span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span> <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span><span class="o">?</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">r</span><span class="p">.</span><span class="nx">handler</span>
      <span class="k">else</span>
        <span class="nv">rewritten_handler = </span><span class="nx">rewrite_function</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">handler</span><span class="p">,</span>
          <span class="nx">http_locals_names</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">helpers_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">defs_names</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">globals</span><span class="p">))</span>

        <span class="nv">context = </span><span class="kc">null</span>
        <span class="nv">locals = </span><span class="p">{}</span>
        <span class="nx">locals</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="k">for</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">globals</span>

        <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">def</span> <span class="k">of</span> <span class="nx">defs</span>
          <span class="nx">locals</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">def</span>

        <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">helper</span> <span class="k">of</span> <span class="nx">helpers</span>
          <span class="nx">locals</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
            <span class="nx">helper</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
            
        <span class="nx">app</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">verb</span><span class="p">]</span> <span class="nx">r</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nf">(req, res, next) -&gt;</span>
          <span class="nv">context = </span><span class="p">{}</span>
          <span class="nx">context</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span>
          <span class="nx">context</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
          <span class="nx">context</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
          <span class="nv">locals.params = </span><span class="nx">context</span>
          <span class="nv">locals.request = </span><span class="nx">req</span>
          <span class="nv">locals.response = </span><span class="nx">res</span>
          <span class="nv">locals.next = </span><span class="nx">next</span>
          <span class="nv">locals.send = </span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">arguments</span>
          <span class="nv">locals.render = </span><span class="o">-&gt;</span>
            <span class="nv">args = </span><span class="p">[]</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">arguments</span>
            <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?=</span> <span class="p">{}</span>
            <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">context</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">args</span>
          <span class="nv">locals.redirect = </span><span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">arguments</span>
          <span class="nv">result = </span><span class="nx">rewritten_handler</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">)</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">contentType</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span><span class="p">)</span> <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">contentType</span><span class="o">?</span>
          <span class="k">if</span> <span class="k">typeof</span> <span class="nx">result</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="k">then</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">result</span>
          <span class="k">else</span> <span class="k">return</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Implements the websockets server with socket.io.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nf">(socket) -&gt;</span>
    <span class="nv">context = </span><span class="p">{}</span>
    <span class="nv">locals = </span><span class="p">{</span><span class="nx">socket</span><span class="p">,</span> <span class="nv">id: </span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nv">client: </span><span class="p">{}}</span>
    <span class="nx">locals</span><span class="p">[</span><span class="nx">g</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="k">for</span> <span class="nx">g</span> <span class="k">in</span> <span class="nx">globals</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">def</span> <span class="k">of</span> <span class="nx">defs</span>
      <span class="nx">locals</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">def</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">helper</span> <span class="k">of</span> <span class="nx">helpers</span>
      <span class="nx">locals</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">helper</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
    
    <span class="nx">ws_handlers</span><span class="p">.</span><span class="nx">connection</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">)</span> <span class="k">if</span> <span class="nx">ws_handlers</span><span class="p">.</span><span class="nx">connection</span><span class="o">?</span>

    <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
      <span class="nv">context = </span><span class="p">{}</span>
      <span class="nx">ws_handlers</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">)</span> <span class="k">if</span> <span class="nx">ws_handlers</span><span class="p">.</span><span class="nx">disconnect</span><span class="o">?</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">h</span> <span class="k">of</span> <span class="nx">ws_handlers</span>
      <span class="k">if</span> <span class="nx">name</span> <span class="o">isnt</span> <span class="s1">&#39;connection&#39;</span> <span class="o">and</span> <span class="nx">name</span> <span class="o">isnt</span> <span class="s1">&#39;disconnect&#39;</span>
        <span class="nx">socket</span><span class="p">.</span><span class="kc">on</span> <span class="nx">name</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
          <span class="nv">context = </span><span class="p">{}</span>
          <span class="nv">locals.params = </span><span class="nx">context</span>
          <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">data</span>
            <span class="nx">context</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
          <span class="nx">h</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">locals</span><span class="p">)</span>

  <span class="p">{</span><span class="nx">app</span><span class="p">,</span> <span class="nx">io</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Takes a function and runs it as a zappa app. Optionally accepts a number for port,
and/or a string for hostname (any order).
Returns an object where <code>app</code> is the express server and <code>io</code> is the socket.io handle.
Ex.:
    require('zappa').run -> get '/': 'hi'
    require('zappa').run 80, -> get '/': 'hi'
    require('zappa').run 'domain.com', 80, -> get '/': 'hi'</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="vi">@run = </span><span class="o">-&gt;</span>
  <span class="nv">host = </span><span class="kc">null</span>
  <span class="nv">port = </span><span class="mi">3000</span>
  <span class="nv">root_function = </span><span class="kc">null</span>

  <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">arguments</span>
    <span class="k">switch</span> <span class="k">typeof</span> <span class="nx">a</span>
      <span class="k">when</span> <span class="s1">&#39;string&#39;</span> <span class="k">then</span> <span class="nv">host = </span><span class="nx">a</span>
      <span class="k">when</span> <span class="s1">&#39;number&#39;</span> <span class="k">then</span> <span class="nv">port = </span><span class="nx">a</span>
      <span class="k">when</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nv">root_function = </span><span class="nx">a</span>

  <span class="nv">zapp = </span><span class="nx">@app</span><span class="p">(</span><span class="nx">root_function</span><span class="p">)</span>
  <span class="nv">app = </span><span class="nx">zapp</span><span class="p">.</span><span class="nx">app</span>

  <span class="k">if</span> <span class="nx">host</span> <span class="k">then</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">host</span>
  <span class="k">else</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">port</span>

  <span class="nx">log</span> <span class="s1">&#39;Express server listening on port %d in %s mode&#39;</span><span class="p">,</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">env</span>

  <span class="nx">zapp</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 